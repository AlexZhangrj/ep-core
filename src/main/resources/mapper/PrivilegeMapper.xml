<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.privilege//DTD Mapper 3.0//EN" "http://mybatis.privilege/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhrenjie04.alex.manager.dao.PrivilegeDao">
	<!-- cache type="privilege.mybatis.caches.memcached.MemcachedCache" / -->
	<resultMap type="com.zhrenjie04.alex.manager.domain.Privilege"
		id="privilegeResult">
        <result property="privilegeId" column="privilege_id" />
        <result property="privilegeName" column="privilege_name" />
        <result property="privilegeCode" column="privilege_code" />
        <result property="frontEndSystem" column="front_end_system" />
        <result property="simpleUrl" column="simple_url" />
        <result property="requestMethod" column="request_method" />
        <result property="isMenu" column="is_menu" />
        <result property="parentId" column="parent_id" />
        <result property="idPath" column="id_path" />
        <result property="isLocked" column="is_locked" />
        <result property="iconClass" column="icon_class" />
        <result property="iconType" column="icon_type" />
        <result property="ab" column="ab" />
        <result property="collapse" column="collapse" />
        <result property="sortValue" column="sort_value" />
        <result property="frontEndSystem" column="front_end_system" />
	</resultMap>
    <select id="queryAll" resultMap="privilegeResult" parameterType="java.util.HashMap"> 
        <![CDATA[
            select * from t_privilege where 1=1
        ]]>
        <if test="ids != null">
                and privilege_id in(
                <foreach collection="ids" item="id" separator=",">#{id}</foreach>
                )
        </if>
        <if test="roleId != null">
        and privilege_id in(select privilege_id from t_role_privilege where role_id=#{roleId} and is_deleted=0)
        </if>
        <if test="userId != null">
        and privilege_id in(select privilege_id from t_role_privilege where role_id in (select role_id from t_job_user_role where job_id=#{jobId} and user_id=#{userId} and is_deleted=0) and is_deleted=0)
        </if>
        and is_deleted=0
        <if test="orderByIdPathAsc == true">
        order by id_path asc
        </if>
        <if test="orderBySortValueAsc == true">
        order by sort_value asc
        </if>
        <if test="ids == null and orderByIdPathAsc == null and orderBySortValueAsc == null">
        order by convert(privilege_name using gbk) asc
        </if>
    </select>
	<select id="queryObject" resultMap="privilegeResult" parameterType="java.util.HashMap"> 
        <![CDATA[
            select * from t_privilege where privilege_id=#{privilegeId}
        ]]>
		and is_deleted=0
	</select>
	<select id="pageQueryAll" resultMap="privilegeResult" parameterType="java.util.HashMap"> 
        select * from t_privilege where is_deleted=0
        <if test="parentId != null and parentId != ''">and parent_id=#{parentId}</if>
        <if test="keyword != null and keyword !=''">
        and (
            privilege_name like concat('%',#{keyword},'%')
            or
            privilege_code like concat('%',#{keyword},'%')
            or
            simpleUrl like concat('%',#{keyword},'%')
            or
            request_method like concat('%',#{keyword},'%')
            or
            id_path like concat('%',#{keyword},'%')
        )
        </if>
		<if test="orderBy != null and orderBy !=''">
			order by ${orderBy}
			<if test="orderType != null and orderType !=''">${orderType}</if>
		</if>
		limit #{start},#{length}
	</select>
	<select id="count" resultType="java.lang.Long" parameterType="java.util.HashMap"> 
        select count(*) from t_privilege where is_deleted=0
        <if test="parentId != null and parentId != ''">and parent_id=#{parentId}</if>
        <if test="keyword != null and keyword !=''">
        and (
            privilege_name like concat('%',#{keyword},'%')
            or
            privilege_code like concat('%',#{keyword},'%')
            or
            simpleUrl like concat('%',#{keyword},'%')
            or
            request_method like concat('%',#{keyword},'%')
            or
            id_path like concat('%',#{keyword},'%')
        )
        </if>
   	</select>
	<insert id="insertObject" parameterType="com.zhrenjie04.alex.manager.domain.Privilege">
        insert into t_privilege(privilege_id,privilege_name,privilege_code,front_end_system,simple_url,request_method,is_menu,icon_class,icon_type,ab,collapse,sort_value,is_deleted,is_locked,parent_id,id_path,creater_id,creater_name)
        values(#{privilegeId},#{privilegeName},#{privilegeCode},#{frontEndSystem},#{simpleUrl},#{requestMethod},#{isMenu},#{iconClass},#{iconType},#{ab},#{collapse},#{sortValue},0,0,#{parentId},#{idPath},#{createrId},#{createrName})
	</insert>
    <update id="updateObject" parameterType="com.zhrenjie04.alex.manager.domain.Privilege">
        update t_privilege set privilege_name=#{privilegeName},
        privilege_code=#{privilegeCode},
        front_end_system=#{frontEndSystem},
        simple_url=#{simpleUrl},
        request_method=#{requestMethod},
        is_menu=#{isMenu},
        parent_id=#{parentId},
        id_path=#{idPath},
        icon_class=#{iconClass},
        icon_type=#{iconType},
        ab=#{ab},
        collapse=#{collapse},
        sort_value=#{sortValue},
        last_modified_time=now(),last_modifier_id=#{lastModifierId},last_modifier_name=#{lastModifierName}
        where
        privilege_id=#{privilegeId}
    </update>
    <update id="updateMoving" parameterType="com.zhrenjie04.alex.manager.domain.Privilege">
        update t_privilege set id_path=#{idPath},parent_id=#{parentId}
        where
        privilege_id=#{privilegeId}
    </update>
    <update id="updateMovingSubNodes" parameterType="java.util.HashMap">
        update t_privilege set id_path=replace(id_path,#{oldIdPathStart},#{newIdPathStart})
        where
        id_path like concat(#{oldIdPathStart},'%');
    </update>
    <update id="updateLocked" parameterType="com.zhrenjie04.alex.manager.domain.Privilege">
        update t_privilege set is_locked=#{isLocked}
        where
        privilege_id=#{privilegeId}
    </update>
    <update id="deleteAll" parameterType="java.util.HashMap">
        update t_privilege set is_deleted=1
        ,last_modified_time=now(),last_modifier_id=#{lastModifierId},last_modifier_name=#{lastModifierName}
        where (
        <foreach collection="idPaths" item="idPath" separator="or">id_path like concat(#{idPath},'%')</foreach>
        )and is_deleted = 0 
    </update>
</mapper> 